# 第六章：如何实现条件逻辑和循环控制？

## 问题引入

你已经学会了如何处理和转换数据，但你可能发现，很多实际场景需要更复杂的逻辑：当订单状态是"待处理"时执行操作A，是"已发货"时执行操作B，是"已完成"时执行操作C；或者需要处理一个包含100个订单的列表，对每个订单执行相同的操作。

"如何根据不同的条件执行不同的操作？如何重复处理多个项目？如何处理错误和重试？如何暂停工作流等待人工审批？"这些流程控制问题可能会让你感到困惑。但不用担心，N8N提供了强大的流程控制能力，包括条件判断、循环处理、错误处理等功能。

本章将详细讲解N8N的流程控制能力，从基础的IF节点和Switch节点开始，逐步学习如何使用Loop节点处理数组数据，掌握错误处理和重试机制，并学会使用Wait节点实现工作流的暂停和恢复。通过本章的学习，你将能够创建包含复杂逻辑的工作流，让自动化真正智能化。

## 核心概念

### 条件判断节点

条件判断是工作流中实现分支逻辑的基础。N8N提供了多种条件判断节点。

#### IF节点

IF节点用于实现简单的二元条件判断（真/假）。

**主要功能**：
- 根据单个条件判断数据流向
- 输出两个分支：True（满足条件）和False（不满足条件）
- 支持多种比较操作（等于、不等于、大于、小于等）

**使用场景**：
- 简单的二元判断
- 需要明确的两个分支
- 条件逻辑相对简单

**IF节点结构**：
```
[数据源] → [IF节点] → [True分支] → [处理A]
                    → [False分支] → [处理B]
```

#### Switch节点

Switch节点用于实现多条件分支判断。

**主要功能**：
- 根据多个条件判断数据流向
- 输出多个分支：每个条件对应一个输出
- 可以设置默认输出（不满足任何条件时）

**使用场景**：
- 多个条件判断
- 需要多个分支
- 条件逻辑相对复杂

**Switch节点结构**：
```
[数据源] → [Switch节点] → [条件1] → [处理A]
                        → [条件2] → [处理B]
                        → [条件3] → [处理C]
                        → [默认] → [处理D]
```

#### IF vs Switch对比

| 特性 | IF节点 | Switch节点 |
|------|--------|-----------|
| **分支数量** | 2个（True/False） | 多个（可自定义） |
| **条件数量** | 1个条件 | 多个条件 |
| **适用场景** | 简单二元判断 | 多条件判断 |
| **复杂度** | ⭐ 简单 | ⭐⭐ 中等 |

### 循环控制节点

循环控制用于重复处理多个数据项。

#### Loop Over Items节点

Loop Over Items节点用于遍历数组中的每个元素。

**主要功能**：
- 将数组拆分为多个数据项
- 对每个数据项执行相同的操作
- 支持嵌套循环

**使用场景**：
- 处理订单列表
- 批量发送邮件
- 遍历数组数据

**循环结构**：
```
[数组数据] → [Loop Over Items] → [处理节点] → [输出]
```

#### Split In Batches节点

Split In Batches节点用于将大量数据分批处理。

**主要功能**：
- 将数据分成多个批次
- 控制批次大小和间隔
- 避免超时和资源耗尽

**使用场景**：
- 处理大量数据
- 避免API限流
- 优化性能

### 错误处理和重试

错误处理是工作流中重要的控制机制。

#### Continue On Fail选项

Continue On Fail选项允许节点失败时继续执行。

**主要功能**：
- 节点失败时不中断工作流
- 继续执行后续节点
- 可以在后续节点中处理错误

**使用场景**：
- 非关键操作
- 需要容错处理
- 批量处理中的部分失败

#### 错误重试机制

N8N支持自动重试失败的节点。

**配置方式**：
- 在节点设置中配置重试次数
- 设置重试间隔
- 配置重试条件

### 工作流暂停和恢复

Wait节点用于暂停工作流执行，等待外部事件。

**主要功能**：
- 暂停工作流执行
- 等待人工审批
- 等待外部事件触发

**使用场景**：
- 需要人工审批的流程
- 等待外部系统响应
- 定时等待

## 详细教程

### 步骤1：使用IF节点实现条件判断

IF节点是最基础的条件判断节点。

#### 1.1 添加IF节点

1. **添加IF节点**
   - 在工作流中添加IF节点
   - 连接到数据源

2. **配置条件**
   - **Condition**：选择条件类型
   - **Value 1**：`{{ $json.status }}`
   - **Operation**：选择操作符（如`equal`、`not equal`、`larger`等）
   - **Value 2**：`active`

3. **连接分支**
   - **True分支**：满足条件的数据
   - **False分支**：不满足条件的数据

[截图位置：IF节点配置界面]

#### 1.2 条件操作符

IF节点支持多种操作符：

| 操作符 | 说明 | 示例 |
|--------|------|------|
| **Equal** | 等于 | `status === 'active'` |
| **Not Equal** | 不等于 | `status !== 'inactive'` |
| **Larger** | 大于 | `age > 18` |
| **Smaller** | 小于 | `price < 100` |
| **Larger Equal** | 大于等于 | `score >= 60` |
| **Smaller Equal** | 小于等于 | `quantity <= 10` |
| **Contains** | 包含 | `name.contains('John')` |
| **Not Contains** | 不包含 | `email.notContains('test')` |
| **Exists** | 存在 | `field !== undefined` |
| **Not Exists** | 不存在 | `field === undefined` |

#### 1.3 组合条件

IF节点支持组合多个条件：

**AND条件**（所有条件都满足）：
- 配置多个条件，都选择True分支

**OR条件**（任一条件满足）：
- 使用表达式：`{{ $json.status === 'active' || $json.verified === true }}`

### 步骤2：使用Switch节点实现多分支

Switch节点用于实现多个条件分支。

#### 2.1 添加Switch节点

1. **添加Switch节点**
   - 在工作流中添加Switch节点
   - 连接到数据源

2. **配置条件**
   - 点击"Add Rule"添加条件
   - 为每个条件配置：
     - **Value**：`{{ $json.status }}`
     - **Operation**：选择操作符
     - **Output**：选择输出编号

3. **设置默认输出**
   - 配置默认输出（可选）
   - 当不满足任何条件时使用默认输出

[截图位置：Switch节点配置界面]

#### 2.2 Switch节点示例

**场景**：根据订单状态执行不同操作

**配置**：
- **条件1**：`{{ $json.status }}` equals `pending` → 输出1（发送待处理通知）
- **条件2**：`{{ $json.status }}` equals `shipped` → 输出2（发送已发货通知）
- **条件3**：`{{ $json.status }}` equals `completed` → 输出3（发送完成通知）
- **默认输出**：输出4（处理未知状态）

### 步骤3：使用Loop Over Items处理数组

Loop Over Items节点用于遍历数组数据。

#### 3.1 添加Loop Over Items节点

1. **添加Loop Over Items节点**
   - 在工作流中添加Loop Over Items节点
   - 连接到包含数组的数据源

2. **配置循环**
   - 节点会自动识别数组字段
   - 或手动指定数组字段：`{{ $json.orders }}`

3. **添加处理节点**
   - 在Loop节点后添加处理节点
   - 处理节点会对每个数组元素执行

[截图位置：Loop Over Items节点配置]

#### 3.2 循环中的数据处理

在循环中，每个数据项都是独立的：

**输入数据**：
```json
{
  "orders": [
    {"id": 1, "amount": 100},
    {"id": 2, "amount": 200},
    {"id": 3, "amount": 300}
  ]
}
```

**循环后**（每个数据项）：
```json
{"id": 1, "amount": 100}
{"id": 2, "amount": 200}
{"id": 3, "amount": 300}
```

#### 3.3 嵌套循环

可以实现嵌套循环：

```
[数据源] → [Loop 1] → [处理1] → [Loop 2] → [处理2] → [输出]
```

### 步骤4：实现错误处理和重试

错误处理是工作流稳定性的重要保障。

#### 4.1 使用Continue On Fail

1. **配置节点**
   - 选择可能失败的节点
   - 在节点设置中勾选"Continue On Fail"

2. **处理错误**
   - 在后续节点中检查错误
   - 使用IF节点判断是否有错误：`{{ $json.error }}`

3. **记录错误**
   - 使用Code节点记录错误信息
   - 或发送错误通知

#### 4.2 配置重试机制

1. **节点设置**
   - 在节点设置中找到"Retry"选项
   - 配置重试次数（如3次）
   - 配置重试间隔（如1000ms）

2. **重试条件**
   - 可以配置重试条件
   - 只有满足条件时才重试

#### 4.3 错误通知

创建错误通知机制：

1. **检测错误**
   - 使用IF节点检测错误
   - 条件：`{{ $json.error }}` exists

2. **发送通知**
   - 在错误分支添加通知节点
   - 发送邮件、Slack消息等

### 步骤5：使用Wait节点暂停工作流

Wait节点用于暂停工作流，等待外部事件。

#### 5.1 添加Wait节点

1. **添加Wait节点**
   - 在工作流中添加Wait节点
   - 连接到需要暂停的位置

2. **配置等待方式**
   - **Wait for Webhook**：等待Webhook触发
   - **Wait for Time**：等待指定时间
   - **Wait for File**：等待文件出现

#### 5.2 等待Webhook触发

1. **配置Wait节点**
   - 选择"Wait for Webhook"
   - 配置Webhook路径

2. **触发恢复**
   - 外部系统调用Webhook URL
   - 工作流自动恢复执行

#### 5.3 等待人工审批

1. **配置Wait节点**
   - 选择"Wait for Webhook"
   - 生成Webhook URL

2. **审批流程**
   - 发送审批请求（邮件、Slack等）
   - 包含审批链接（Webhook URL）
   - 审批通过/拒绝后调用Webhook
   - 工作流根据结果继续执行

## 实践练习

### 练习1：条件判断基础

**任务目标**：创建一个工作流，根据输入数据的不同值执行3条不同的路径，使用IF和Switch节点

**前置条件**：
- N8N已安装并运行
- 理解基本的条件判断概念

**详细步骤**：

1. **创建测试数据**
   - 添加Manual Trigger节点
   - 添加Set节点，创建测试数据：
     - `status`: `pending`、`shipped`、`completed`（分别测试）

2. **使用IF节点实现简单条件**
   - 添加IF节点
   - 配置条件：`{{ $json.status }}` equals `pending`
   - True分支：添加Set节点，设置`action: "send_pending_notification"`
   - False分支：添加另一个IF节点，判断`shipped`
   - 实现3个分支

3. **使用Switch节点实现多分支**
   - 添加Switch节点
   - 配置3个条件：
     - `pending` → 输出1
     - `shipped` → 输出2
     - `completed` → 输出3
   - 每个输出连接不同的处理节点

4. **对比两种方式**
   - 执行两种工作流
   - 对比复杂度和可维护性
   - 记录适用场景

**预期结果**：
- 成功实现3条不同的执行路径
- IF节点和Switch节点都能正常工作
- 完成对比分析

**验证方法**：
- 测试不同的输入值
- 检查每个分支是否正确执行
- 验证对比分析是否合理

**对比分析表**：

| 特性 | IF节点 | Switch节点 |
|------|--------|-----------|
| 配置复杂度 | 较高（需要嵌套） | 较低（直接配置） |
| 可读性 | 中等 | 高 |
| 维护性 | 中等 | 高 |
| 适用场景 | 简单二元判断 | 多条件判断 |

**扩展挑战**：
- 实现4个或更多分支
- 添加默认分支处理
- 实现条件组合（AND/OR）

**故障排除**：
- **问题**：条件判断不准确
  - **解决**：检查数据类型，确保比较值类型一致
- **问题**：分支未执行
  - **解决**：检查条件配置，确保条件逻辑正确

### 练习2：嵌套条件练习

**任务目标**：创建一个复杂的条件判断工作流，实现3层嵌套的条件逻辑，绘制条件决策树

**前置条件**：
- 完成练习1
- 理解嵌套条件概念

**详细步骤**：

1. **设计条件逻辑**
   - 定义3层条件：
     - 第1层：用户类型（admin/user/guest）
     - 第2层：订单状态（pending/shipped/completed）
     - 第3层：订单金额（>1000/500-1000/<500）

2. **实现嵌套条件**
   - 第1层：使用Switch节点判断用户类型
   - 第2层：在每个用户类型分支添加Switch节点判断订单状态
   - 第3层：在每个订单状态分支添加IF节点判断订单金额

3. **绘制条件决策树**
   - 使用图表工具绘制决策树
   - 标注每个分支的条件和操作
   - 标注所有可能的路径

4. **测试所有条件组合**
   - 创建测试数据覆盖所有组合
   - 执行工作流
   - 验证每个路径是否正确执行

**预期结果**：
- 成功实现3层嵌套条件
- 完成条件决策树
- 所有条件组合测试通过

**验证方法**：
- 检查决策树是否完整
- 测试所有可能的条件组合
- 验证每个路径的执行结果

**条件决策树示例**：

```
用户类型
├─ admin
│  ├─ pending
│  │  ├─ >1000 → 操作A1
│  │  └─ <=1000 → 操作A2
│  ├─ shipped → 操作A3
│  └─ completed → 操作A4
├─ user
│  ├─ pending → 操作B1
│  └─ shipped → 操作B2
└─ guest → 操作C1
```

**扩展挑战**：
- 实现4层或更多层嵌套
- 优化条件逻辑，减少嵌套深度
- 使用Code节点实现复杂条件判断

**故障排除**：
- **问题**：嵌套过深难以维护
  - **解决**：考虑使用Code节点或重构逻辑
- **问题**：条件组合遗漏
  - **解决**：使用决策表确保覆盖所有组合

### 练习3：循环处理实战

**任务目标**：创建一个工作流，处理包含100个项目的数组，使用Loop Over Items节点遍历，添加进度跟踪和错误处理

**前置条件**：
- 完成前面的练习
- 理解循环处理概念

**详细步骤**：

1. **创建测试数据**
   - 添加Manual Trigger节点
   - 添加Code节点生成100个项目的数组：
   ```javascript
   const items = [];
   for (let i = 1; i <= 100; i++) {
     items.push({
       json: {
         id: i,
         name: `Item ${i}`,
         status: Math.random() > 0.8 ? 'error' : 'ok',
         value: Math.floor(Math.random() * 1000)
       }
     });
   }
   return items;
   ```

2. **使用Loop Over Items节点**
   - 添加Loop Over Items节点
   - 节点会自动识别数组
   - 或手动指定：`{{ $json }}`

3. **处理每个项目**
   - 在Loop节点后添加处理节点
   - 对每个项目执行操作（如发送通知、更新状态等）

4. **添加进度跟踪**
   - 使用Code节点跟踪进度：
   ```javascript
   const current = $input.item.json.id;
   const total = 100;
   const progress = (current / total * 100).toFixed(1);
   
   return [{
     json: {
       ...$input.item.json,
       progress: progress + '%',
       current: current,
       total: total
     }
   }];
   ```

5. **添加错误处理**
   - 在处理节点中配置"Continue On Fail"
   - 添加IF节点检测错误
   - 记录错误信息

**预期结果**：
- 成功处理100个项目
- 进度跟踪正常工作
- 错误处理机制有效

**验证方法**：
- 检查所有项目是否都处理
- 验证进度信息是否准确
- 确认错误项目被正确记录

**扩展挑战**：
- 实现并行处理（使用Split In Batches）
- 添加处理统计（成功/失败数量）
- 实现断点续传（从失败处继续）

**故障排除**：
- **问题**：循环处理超时
  - **解决**：使用Split In Batches分批处理
- **问题**：进度跟踪不准确
  - **解决**：检查进度计算逻辑，确保正确

### 练习4：条件+循环组合项目

**任务目标**：创建一个工作流，从API获取订单列表，遍历每个订单，根据订单状态执行不同操作，统计每种状态的订单数量

**前置条件**：
- 完成前面的练习
- 有一个可用的API（可以使用测试API）

**详细步骤**：

1. **获取订单列表**
   - 添加Schedule Trigger节点
   - 添加HTTP Request节点
   - 配置API URL（如：`https://jsonplaceholder.typicode.com/posts`）
   - 或使用测试数据

2. **使用Loop Over Items遍历订单**
   - 添加Loop Over Items节点
   - 遍历订单数组

3. **根据订单状态分流**
   - 在Loop节点后添加Switch节点
   - 配置多个条件：
     - `pending` → 发送待处理通知
     - `shipped` → 发送已发货通知
     - `completed` → 发送完成通知
     - 默认 → 记录未知状态

4. **统计订单数量**
   - 在Switch节点后添加Code节点
   - 统计每种状态的数量：
   ```javascript
   const items = $input.all();
   const stats = {
     pending: 0,
     shipped: 0,
     completed: 0,
     unknown: 0
   };
   
   items.forEach(item => {
     const status = item.json.status || 'unknown';
     if (stats[status] !== undefined) {
       stats[status]++;
     } else {
       stats.unknown++;
     }
   });
   
   return [{
     json: {
       ...stats,
       total: items.length
     }
   }];
   ```

5. **输出统计结果**
   - 添加输出节点（如Email、Slack）
   - 发送统计报告

**预期结果**：
- 成功遍历所有订单
- 根据状态正确分流
- 统计结果准确

**验证方法**：
- 检查每个订单是否处理
- 验证分流是否正确
- 确认统计数量准确

**扩展挑战**：
- 添加订单金额统计
- 实现订单分组处理
- 添加异常订单告警

**故障排除**：
- **问题**：循环处理部分订单失败
  - **解决**：添加错误处理，使用Continue On Fail
- **问题**：统计结果不准确
  - **解决**：检查统计逻辑，确保正确计数

### 练习5：错误处理和重试逻辑

**任务目标**：创建一个可能失败的工作流，实现错误捕获和重试机制，创建错误通知机制

**前置条件**：
- 完成前面的练习
- 理解错误处理概念

**详细步骤**：

1. **创建可能失败的工作流**
   - 添加Manual Trigger节点
   - 添加HTTP Request节点
   - 使用一个可能失败的URL（如：`https://httpstat.us/500`）

2. **配置错误处理**
   - 在HTTP Request节点中配置"Continue On Fail"
   - 添加IF节点检测错误：
     - 条件：`{{ $json.error }}` exists

3. **实现重试机制**
   - 在HTTP Request节点中配置重试：
     - 重试次数：3
     - 重试间隔：1000ms

4. **创建错误通知机制**
   - 在错误分支添加通知节点
   - 发送错误信息到Email或Slack
   - 包含错误详情和重试信息

5. **记录错误日志**
   - 添加Code节点记录错误：
   ```javascript
   const error = $input.item.json.error;
   return [{
     json: {
       timestamp: new Date().toISOString(),
       error: error.message || error,
       retryCount: $input.item.json.retryCount || 0
     }
   }];
   ```

**预期结果**：
- 错误被正确捕获
- 重试机制正常工作
- 错误通知成功发送

**验证方法**：
- 测试失败场景
- 验证重试是否执行
- 检查错误通知是否收到

**扩展挑战**：
- 实现智能重试（根据错误类型决定是否重试）
- 添加错误分类和统计
- 实现错误恢复机制

**故障排除**：
- **问题**：重试不生效
  - **解决**：检查重试配置，确保节点支持重试
- **问题**：错误通知未发送
  - **解决**：检查错误检测逻辑，确保正确识别错误

### 练习6：工作流暂停和恢复

**任务目标**：创建一个需要人工审批的工作流，使用Wait节点暂停执行，实现审批通过/拒绝的分支逻辑

**前置条件**：
- 完成前面的练习
- 理解Wait节点概念

**详细步骤**：

1. **创建工作流**
   - 添加Manual Trigger节点
   - 添加Set节点，创建审批请求数据：
     - `requestId`: 唯一ID
     - `requester`: 申请人
     - `amount`: 金额
     - `reason`: 申请原因

2. **发送审批请求**
   - 添加Email节点或Slack节点
   - 发送审批通知
   - 包含审批链接（Webhook URL）

3. **添加Wait节点**
   - 添加Wait节点
   - 选择"Wait for Webhook"
   - 配置Webhook路径：`/approval/{{ $json.requestId }}`
   - 记录Webhook URL

4. **实现审批分支**
   - 在Wait节点后添加Switch节点
   - 根据审批结果分流：
     - `approved` → 执行操作（如处理申请）
     - `rejected` → 拒绝操作（如发送拒绝通知）
     - 默认 → 超时处理

5. **测试工作流**
   - 执行工作流
   - 使用Webhook URL模拟审批
   - 验证分支逻辑

**预期结果**：
- 工作流成功暂停
- 审批请求成功发送
- 审批后正确恢复并执行相应分支

**验证方法**：
- 检查Wait节点是否暂停
- 验证Webhook URL是否可访问
- 测试审批通过和拒绝两种场景

**扩展挑战**：
- 添加审批超时处理
- 实现多级审批
- 添加审批历史记录

**故障排除**：
- **问题**：Wait节点不暂停
  - **解决**：检查Wait节点配置，确保选择正确的等待方式
- **问题**：Webhook无法触发
  - **解决**：检查Webhook URL，确保N8N可访问

## 常见问题

**Q1：IF节点和Switch节点有什么区别？**

A：
- **IF节点**：用于二元判断（真/假），只有2个输出分支
- **Switch节点**：用于多条件判断，可以有多个输出分支
- **选择建议**：简单二元判断用IF，多个条件用Switch

**Q2：如何在循环中访问当前索引？**

A：在Loop Over Items中，可以使用表达式：
```javascript
{{ $input.item.json.__index }}  // 当前索引（从0开始）
{{ $input.item.json.__index + 1 }}  // 从1开始的索引
```

**Q3：如何跳出循环？**

A：N8N的Loop节点会处理所有项目，无法直接跳出。如果需要提前结束，可以：
- 使用Code节点过滤数据，只处理需要的项目
- 使用IF节点跳过不需要的项目

**Q4：Continue On Fail和重试有什么区别？**

A：
- **Continue On Fail**：节点失败后继续执行后续节点，不重试
- **重试**：节点失败后自动重试，重试失败后才继续或停止
- 可以同时使用：重试失败后，如果设置了Continue On Fail，会继续执行

**Q5：如何实现并行处理？**

A：
- 使用多个并行分支（不连接，都从同一节点出发）
- 使用Split In Batches分批并行处理
- 使用Code节点实现并行逻辑

**Q6：Wait节点会占用资源吗？**

A：Wait节点会暂停工作流执行，但不会占用大量资源。工作流会等待，直到触发条件满足。

**Q7：如何实现条件组合（AND/OR）？**

A：
- **AND**：在IF节点中使用表达式：`{{ $json.status === 'active' && $json.verified === true }}`
- **OR**：在IF节点中使用表达式：`{{ $json.role === 'admin' || $json.role === 'moderator' }}`
- 或使用多个IF节点嵌套

**Q8：循环中如何处理错误？**

A：
- 在处理节点中配置"Continue On Fail"
- 在循环后添加错误检测节点
- 记录错误信息，继续处理其他项目

**Q9：如何统计循环处理的结果？**

A：
- 在循环后添加Code节点
- 使用`$input.all()`获取所有处理结果
- 进行统计计算（成功数、失败数等）

**Q10：Wait节点的Webhook URL如何获取？**

A：
- 在Wait节点配置中会显示Webhook URL
- 或使用表达式：`{{ $workflow.webhookUrl }}`
- 确保N8N可以访问（配置正确的域名和端口）

## 知识检查

### 选择题

1. **IF节点和Switch节点的主要区别是什么？**
   - A. IF节点更简单
   - B. Switch节点支持多个分支
   - C. IF节点只能判断真/假
   - D. 以上都是
   - **答案**：D
   - **解释**：IF节点用于二元判断，Switch节点支持多个条件分支。

2. **Loop Over Items节点的作用是什么？**
   - A. 合并数组
   - B. 遍历数组中的每个元素
   - C. 过滤数组
   - D. 排序数组
   - **答案**：B
   - **解释**：Loop Over Items节点用于遍历数组中的每个元素。

3. **Continue On Fail选项的作用是什么？**
   - A. 自动重试
   - B. 节点失败时继续执行
   - C. 忽略错误
   - D. 停止工作流
   - **答案**：B
   - **解释**：Continue On Fail允许节点失败时继续执行后续节点。

4. **Wait节点可以等待什么？**
   - A. 只能等待时间
   - B. 只能等待Webhook
   - C. 可以等待Webhook、时间或文件
   - D. 不能等待
   - **答案**：C
   - **解释**：Wait节点支持等待Webhook、时间或文件。

5. **如何实现嵌套条件判断？**
   - A. 只能使用Switch节点
   - B. 只能使用IF节点
   - C. 可以使用IF节点或Switch节点嵌套
   - D. 不能实现嵌套
   - **答案**：C
   - **解释**：可以使用IF节点或Switch节点实现嵌套条件判断。

### 简答题

1. **请解释IF节点和Switch节点的区别，并说明各自的适用场景。**

   **答案示例**：
   - **IF节点**：
     - 用于二元判断（真/假）
     - 只有2个输出分支
     - 适合简单的条件判断
     - 示例：判断订单是否完成
   - **Switch节点**：
     - 用于多条件判断
     - 可以有多个输出分支
     - 适合复杂的条件判断
     - 示例：根据订单状态执行不同操作

2. **如何使用Loop Over Items节点处理数组数据？请说明步骤。**

   **答案示例**：
   1. 确保数据源包含数组字段
   2. 添加Loop Over Items节点
   3. 节点会自动识别数组，或手动指定数组字段
   4. 在Loop节点后添加处理节点
   5. 处理节点会对每个数组元素执行
   6. 所有元素处理完成后，继续执行后续节点

3. **如何实现错误处理和重试机制？请列出主要步骤。**

   **答案示例**：
   1. 在可能失败的节点中配置"Continue On Fail"
   2. 配置重试次数和重试间隔
   3. 在后续节点中检测错误（使用IF节点）
   4. 记录错误信息（使用Code节点）
   5. 发送错误通知（使用Email或Slack节点）

4. **Wait节点有哪些等待方式？各适用于什么场景？**

   **答案示例**：
   - **Wait for Webhook**：
     - 等待外部Webhook触发
     - 适用于人工审批、外部系统响应
   - **Wait for Time**：
     - 等待指定时间
     - 适用于定时延迟、批量处理间隔
   - **Wait for File**：
     - 等待文件出现
     - 适用于文件处理场景

5. **如何实现条件+循环的组合？请给出一个实际例子。**

   **答案示例**：
   示例：处理订单列表，根据订单状态执行不同操作
   1. 获取订单列表（数组）
   2. 使用Loop Over Items遍历每个订单
   3. 在循环中使用Switch节点根据订单状态分流
   4. 每个状态分支执行不同的操作
   5. 循环结束后统计处理结果

### 实践题

1. **创建条件判断工作流**
   - 实现至少3个条件分支
   - 使用IF和Switch节点
   - 测试所有分支

2. **实现循环处理**
   - 处理包含多个项目的数组
   - 添加进度跟踪
   - 实现错误处理

3. **创建审批工作流**
   - 使用Wait节点暂停
   - 实现审批通过/拒绝分支
   - 测试完整流程

## 延伸阅读

### 官方资源

1. **N8N条件节点文档**
   - 网址：https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.if/
   - 内容：IF节点和Switch节点的详细文档

2. **N8N循环节点文档**
   - 网址：https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.splitinbatches/
   - 内容：循环处理节点的详细文档

3. **N8N错误处理文档**
   - 网址：https://docs.n8n.io/workflows/error-handling/
   - 内容：错误处理和重试的最佳实践

### 学习资源

1. **流程控制模式**
   - 学习常见流程控制模式
   - 理解条件判断最佳实践
   - 掌握循环处理优化方法

2. **错误处理策略**
   - 学习错误处理设计模式
   - 理解重试策略
   - 掌握错误恢复机制

3. **工作流设计模式**
   - 学习工作流设计模式
   - 理解复杂逻辑的组织方式
   - 掌握可维护性设计原则

### 相关工具和概念

1. **流程控制理论**
   - 学习条件判断和循环的基本概念
   - 理解流程图的绘制方法
   - 掌握决策树的设计

2. **错误处理最佳实践**
   - 学习错误分类和处理策略
   - 理解重试机制的设计
   - 掌握错误监控和告警

3. **工作流优化**
   - 学习工作流性能优化
   - 理解并行处理策略
   - 掌握资源管理方法

### 下一步学习

完成本章学习后，建议你：

1. **完成所有实践练习**
   - 确保你能够实现条件判断和循环控制
   - 掌握错误处理和重试机制
   - 理解工作流暂停和恢复

2. **优化现有工作流**
   - 改进条件判断逻辑
   - 优化循环处理性能
   - 添加错误处理机制

3. **创建复杂工作流**
   - 结合条件、循环、错误处理
   - 创建实际业务场景的工作流
   - 积累实践经验

4. **开始第七章学习**
   - 下一章将教你如何调试和优化工作流
   - 学习调试工具和方法
   - 准备好优化你的工作流性能

---

## 快速参考

### 条件节点对比

| 节点 | 分支数量 | 适用场景 | 复杂度 |
|------|---------|---------|--------|
| IF | 2个（True/False） | 简单二元判断 | ⭐ 简单 |
| Switch | 多个（可自定义） | 多条件判断 | ⭐⭐ 中等 |

### 循环节点对比

| 节点 | 功能 | 适用场景 |
|------|------|---------|
| Loop Over Items | 遍历数组元素 | 处理数组数据 |
| Split In Batches | 分批处理数据 | 处理大量数据 |

### 常用条件操作符

| 操作符 | 说明 | 示例 |
|--------|------|------|
| Equal | 等于 | `status === 'active'` |
| Not Equal | 不等于 | `status !== 'inactive'` |
| Larger | 大于 | `age > 18` |
| Contains | 包含 | `name.contains('John')` |
| Exists | 存在 | `field !== undefined` |

### 错误处理选项

| 选项 | 功能 | 使用场景 |
|------|------|---------|
| Continue On Fail | 失败后继续执行 | 非关键操作 |
| Retry | 自动重试 | 临时性错误 |
| Error Trigger | 错误触发器 | 全局错误处理 |

---

**恭喜你完成第六章的学习！现在你已经能够实现复杂的条件逻辑和循环控制了。准备好学习如何调试和优化工作流，让它们运行得更快更稳定了吗？** 🚀

