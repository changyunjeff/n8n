# 第五章：如何处理和转换数据？

## 问题引入

你已经学会了如何创建工作流，连接各种第三方服务。现在，你可能发现了一个新的挑战：从不同来源获取的数据格式往往不一致，有些数据是嵌套的JSON，有些是数组，有些字段名称不符合你的需求，有些数据需要计算或格式化。

"如何从复杂的JSON中提取我需要的数据？如何将多个数据源合并？如何根据条件过滤数据？如何格式化日期和数字？"这些数据处理问题可能会让你感到困惑。但不用担心，N8N提供了强大的数据处理能力，包括多种数据操作节点和灵活的表达式语言。

本章将详细讲解N8N的数据处理能力，从基础的JSON数据结构开始，逐步学习如何使用Set、Code、Function等节点处理和转换数据，掌握表达式语言的用法，并学会数据合并、过滤、排序等高级操作。通过本章的学习，你将能够处理任何复杂的数据场景，让数据真正为你所用。

## 核心概念

### N8N的数据结构

理解N8N的数据结构是处理数据的基础。N8N使用JSON格式来传递和存储数据。

#### JSON数据格式

JSON（JavaScript Object Notation）是一种轻量级的数据交换格式，易于阅读和编写。

**基本JSON结构**：
```json
{
  "json": {
    "name": "John",
    "age": 30,
    "email": "john@example.com"
  }
}
```

**嵌套JSON结构**：
```json
{
  "json": {
    "user": {
      "name": "John",
      "address": {
        "city": "Beijing",
        "country": "China"
      }
    },
    "orders": [
      {"id": 1, "amount": 100},
      {"id": 2, "amount": 200}
    ]
  }
}
```

#### 数据项（Item）

在N8N中，每个数据项都是一个JSON对象：
- **单个数据项**：包含一个JSON对象
- **多个数据项**：包含多个JSON对象的数组

**数据项结构**：
```json
{
  "json": { /* 数据内容 */ },
  "binary": { /* 二进制数据 */ },
  "error": null
}
```

### 数据操作节点

N8N提供了多种节点来处理和转换数据。

#### Set节点

Set节点用于添加、修改或删除数据字段。

**主要功能**：
- 添加新字段
- 修改现有字段
- 删除字段
- 重命名字段

**使用场景**：
- 标准化数据格式
- 添加计算字段
- 重命名字段以匹配下游系统

#### Code节点

Code节点允许你执行JavaScript代码来处理数据。

**主要功能**：
- 复杂的数据计算
- 数据转换和格式化
- 条件逻辑处理
- 数组操作

**使用场景**：
- 复杂的数据处理逻辑
- 需要循环或条件判断的场景
- 自定义数据转换

#### Function节点

Function节点是Code节点的简化版本，用于快速编写简单的数据处理函数。

**主要功能**：
- 快速编写数据处理函数
- 简单的数据转换
- 字段操作

#### Item Lists节点

Item Lists节点用于处理数组数据。

**主要功能**：
- 拆分数组为多个数据项
- 合并多个数据项为数组
- 数组排序和过滤

### N8N表达式语言

表达式语言是N8N中访问和操作数据的强大工具。

#### 表达式语法

表达式使用`{{ }}`包裹：
```javascript
{{ $json.fieldName }}
{{ $json.array[0] }}
{{ $now }}
```

#### 常用表达式函数

**字符串操作**：
- `{{ $json.name.toUpperCase() }}`：转换为大写
- `{{ $json.name.toLowerCase() }}`：转换为小写
- `{{ $json.name.substring(0, 5) }}`：截取字符串
- `{{ $json.name.replace('old', 'new') }}`：替换字符串

**数字操作**：
- `{{ $json.price.toFixed(2) }}`：保留2位小数
- `{{ $json.quantity + 1 }}`：加法
- `{{ $json.total / $json.count }}`：除法

**日期操作**：
- `{{ $now }}`：当前时间
- `{{ $now.toISOString() }}`：ISO格式日期
- `{{ $json.date.format('YYYY-MM-DD') }}`：格式化日期

**数组操作**：
- `{{ $json.items.length }}`：数组长度
- `{{ $json.items[0] }}`：第一个元素
- `{{ $json.items.filter(item => item.active) }}`：过滤数组

## 详细教程

### 步骤1：理解JSON数据结构

在开始处理数据之前，让我们先深入理解JSON数据结构。

#### 1.1 JSON基本结构

JSON由键值对组成：
```json
{
  "key": "value",
  "number": 123,
  "boolean": true,
  "array": [1, 2, 3],
  "object": {
    "nested": "value"
  }
}
```

#### 1.2 访问JSON数据

在N8N中，使用表达式访问JSON数据：

**访问简单字段**：
```javascript
{{ $json.name }}
{{ $json.age }}
```

**访问嵌套字段**：
```javascript
{{ $json.user.name }}
{{ $json.user.address.city }}
```

**访问数组元素**：
```javascript
{{ $json.items[0] }}
{{ $json.items[0].name }}
```

**访问数组长度**：
```javascript
{{ $json.items.length }}
```

#### 1.3 数据类型

N8N支持多种数据类型：
- **字符串（String）**：`"text"`
- **数字（Number）**：`123`、`45.67`
- **布尔值（Boolean）**：`true`、`false`
- **数组（Array）**：`[1, 2, 3]`
- **对象（Object）**：`{"key": "value"}`
- **空值（Null）**：`null`

### 步骤2：使用Set节点处理数据

Set节点是最常用的数据操作节点之一。

#### 2.1 添加字段

1. **添加Set节点**
   - 在工作流中添加Set节点
   - 连接到数据源节点

2. **配置Set节点**
   - **Keep Only Set Fields**：取消勾选（保留原有字段）
   - **Values to Set**：点击"Add Value"
     - **Name**：`fullName`
     - **Value**：`{{ $json.firstName }} {{ $json.lastName }}`

3. **保存配置**

**示例**：
- 输入数据：`{"firstName": "John", "lastName": "Doe"}`
- Set节点添加：`fullName: "John Doe"`
- 输出数据：`{"firstName": "John", "lastName": "Doe", "fullName": "John Doe"}`

#### 2.2 修改字段

使用Set节点修改现有字段：
- **Name**：`age`
- **Value**：`{{ $json.age + 1 }}`

#### 2.3 删除字段

设置**Keep Only Set Fields**为true，只保留设置的字段。

#### 2.4 重命名字段

1. 添加新字段（使用新名称）
2. 设置**Keep Only Set Fields**为true
3. 只保留需要的字段

### 步骤3：使用Code节点处理复杂逻辑

Code节点允许你编写JavaScript代码来处理数据。

#### 3.1 基本用法

1. **添加Code节点**
   - 在工作流中添加Code节点

2. **选择执行模式**
   - **Run Once for All Items**：处理所有数据项
   - **Run Once for Each Item**：为每个数据项执行

3. **编写代码**
```javascript
// 获取输入数据
const items = $input.all();

// 处理数据
const processedItems = items.map(item => {
  return {
    json: {
      name: item.json.name.toUpperCase(),
      age: item.json.age,
      category: item.json.age >= 18 ? 'adult' : 'minor'
    }
  };
});

// 返回处理后的数据
return processedItems;
```

#### 3.2 常用操作

**数据转换**：
```javascript
const items = $input.all();
return items.map(item => ({
  json: {
    ...item.json,
    price: parseFloat(item.json.price).toFixed(2),
    date: new Date(item.json.date).toISOString()
  }
}));
```

**数据过滤**：
```javascript
const items = $input.all();
return items.filter(item => item.json.status === 'active');
```

**数据计算**：
```javascript
const items = $input.all();
const total = items.reduce((sum, item) => sum + item.json.amount, 0);
return [{ json: { total } }];
```

### 步骤4：使用表达式语言

表达式语言是N8N中访问和操作数据的核心工具。

#### 4.1 基本表达式

**访问数据**：
```javascript
{{ $json.name }}              // 访问字段
{{ $json.user.email }}        // 访问嵌套字段
{{ $json.items[0] }}          // 访问数组元素
```

**使用函数**：
```javascript
{{ $json.name.toUpperCase() }}           // 字符串转大写
{{ $json.price.toFixed(2) }}             // 数字格式化
{{ $json.date.format('YYYY-MM-DD') }}     // 日期格式化
```

#### 4.2 条件表达式

**三元运算符**：
```javascript
{{ $json.age >= 18 ? 'adult' : 'minor' }}
{{ $json.status === 'active' ? $json.name : 'N/A' }}
```

**逻辑运算符**：
```javascript
{{ $json.status === 'active' && $json.verified === true }}
{{ $json.role === 'admin' || $json.role === 'moderator' }}
```

#### 4.3 字符串操作

**字符串方法**：
```javascript
{{ $json.name.length }}                    // 字符串长度
{{ $json.name.substring(0, 10) }}         // 截取字符串
{{ $json.name.replace('old', 'new') }}     // 替换字符串
{{ $json.email.split('@')[0] }}            // 分割字符串
```

#### 4.4 数学运算

**基本运算**：
```javascript
{{ $json.price + 10 }}                     // 加法
{{ $json.total - $json.discount }}         // 减法
{{ $json.quantity * $json.price }}        // 乘法
{{ $json.total / $json.count }}            // 除法
{{ $json.number % 2 }}                     // 取模
```

**数学函数**：
```javascript
{{ Math.round($json.price) }}              // 四舍五入
{{ Math.floor($json.price) }}              // 向下取整
{{ Math.ceil($json.price) }}               // 向上取整
{{ Math.max($json.a, $json.b) }}          // 最大值
{{ Math.min($json.a, $json.b) }}          // 最小值
```

### 步骤5：数据合并和聚合

处理来自多个数据源的数据是常见需求。

#### 5.1 使用Merge节点

Merge节点用于合并多个数据流。

1. **添加Merge节点**
   - 连接多个数据源到Merge节点

2. **选择合并模式**
   - **Merge By Index**：按索引合并
   - **Merge By Key**：按键值合并
   - **Append**：追加数据

3. **配置合并规则**
   - 设置合并键（如果使用Merge By Key）
   - 处理冲突字段

#### 5.2 使用Code节点合并数据

```javascript
const items1 = $input.item.json.source1;
const items2 = $input.item.json.source2;
const items3 = $input.item.json.source3;

return [{
  json: {
    ...items1,
    ...items2,
    ...items3,
    mergedAt: new Date().toISOString()
  }
}];
```

### 步骤6：数据过滤和条件处理

根据条件过滤和处理数据是数据处理的重要部分。

#### 6.1 使用IF节点

IF节点用于根据条件分流数据。

1. **添加IF节点**
   - 连接到数据源

2. **配置条件**
   - **Condition**：选择条件类型
   - **Value 1**：`{{ $json.status }}`
   - **Operation**：`equal`
   - **Value 2**：`active`

3. **处理两个分支**
   - **True分支**：满足条件的数据
   - **False分支**：不满足条件的数据

#### 6.2 使用Switch节点

Switch节点用于多条件分流。

1. **添加Switch节点**
2. **配置多个条件**
   - 每个条件对应一个输出
   - 可以设置默认输出

#### 6.3 使用Code节点过滤

```javascript
const items = $input.all();
return items.filter(item => {
  return item.json.status === 'active' && 
         item.json.amount > 100;
});
```

## 实践练习

### 练习1：数据提取练习

**任务目标**：从复杂的JSON响应中提取嵌套数据，使用表达式提取数组元素，创建可重复使用的数据提取模板

**前置条件**：
- N8N已安装并运行
- 理解基本的JSON结构

**详细步骤**：

1. **创建测试数据**
   - 添加Manual Trigger节点
   - 添加Set节点，创建复杂的JSON数据：
   ```json
   {
     "company": {
       "name": "Tech Corp",
       "employees": [
         {"id": 1, "name": "John", "department": "Engineering", "salary": 5000},
         {"id": 2, "name": "Jane", "department": "Marketing", "salary": 4500},
         {"id": 3, "name": "Bob", "department": "Engineering", "salary": 6000}
       ],
       "departments": {
         "Engineering": {"budget": 100000, "head": "Alice"},
         "Marketing": {"budget": 50000, "head": "Charlie"}
       }
     }
   }
   ```

2. **提取嵌套数据**
   - 添加Set节点
   - 提取公司名称：`{{ $json.company.name }}`
   - 提取部门预算：`{{ $json.company.departments.Engineering.budget }}`

3. **提取数组元素**
   - 添加Code节点
   - 提取所有员工姓名：
   ```javascript
   const employees = $input.item.json.company.employees;
   return employees.map(emp => ({
     json: {
       employeeName: emp.name,
       department: emp.department,
       salary: emp.salary
     }
   }));
   ```

4. **创建数据提取模板**
   - 使用Set节点创建可重复使用的模板
   - 记录常用的提取表达式
   - 创建表达式速查表

**预期结果**：
- 成功提取嵌套数据
- 成功提取数组元素
- 创建数据提取模板

**验证方法**：
- 检查提取的数据是否正确
- 验证表达式是否有效
- 检查模板是否可重复使用

**数据提取模板示例**：

| 数据类型 | 表达式 | 说明 |
|---------|--------|------|
| 嵌套对象 | `{{ $json.user.profile.name }}` | 访问嵌套字段 |
| 数组第一个元素 | `{{ $json.items[0] }}` | 访问数组第一个元素 |
| 数组长度 | `{{ $json.items.length }}` | 获取数组长度 |
| 数组过滤 | `{{ $json.items.filter(i => i.active) }}` | 过滤数组 |

**扩展挑战**：
- 提取多个嵌套层级的数据
- 处理动态深度的嵌套结构
- 创建通用的数据提取函数

**故障排除**：
- **问题**：表达式返回undefined
  - **解决**：检查字段路径是否正确，使用`?.`安全访问
- **问题**：数组访问越界
  - **解决**：检查数组长度，使用条件判断

### 练习2：数据转换实战

**任务目标**：创建从API获取原始数据的工作流，使用Set节点重命名字段，使用Code节点进行数据计算和格式化

**前置条件**：
- 完成练习1
- 有一个可用的API（可以使用测试API）

**详细步骤**：

1. **获取原始数据**
   - 添加Schedule Trigger节点
   - 添加HTTP Request节点
   - 配置API URL（如：`https://jsonplaceholder.typicode.com/users`）

2. **使用Set节点重命名字段**
   - 添加Set节点
   - 重命名字段：
     - `name` → `fullName`
     - `email` → `emailAddress`
     - `address.city` → `city`
     - `address.zipcode` → `postalCode`

3. **使用Code节点进行数据计算**
   - 添加Code节点
   - 计算字段：
   ```javascript
   const items = $input.all();
   return items.map(item => ({
     json: {
       ...item.json,
       nameLength: item.json.fullName.length,
       emailDomain: item.json.emailAddress.split('@')[1],
       isLongName: item.json.fullName.length > 10
     }
   }));
   ```

4. **格式化数据**
   - 添加Set节点
   - 格式化日期、数字等：
     - `formattedDate`: `{{ $now.format('YYYY-MM-DD HH:mm:ss') }}`
     - `formattedPrice`: `{{ $json.price.toFixed(2) }}`

5. **测试工作流**
   - 执行工作流
   - 检查数据转换结果

**预期结果**：
- 字段成功重命名
- 数据计算正确
- 数据格式化正确

**验证方法**：
- 检查字段名称是否更改
- 验证计算结果是否正确
- 检查格式化是否符合要求

**扩展挑战**：
- 处理多个数据源
- 实现复杂的数据转换逻辑
- 添加数据验证

**故障排除**：
- **问题**：字段重命名失败
  - **解决**：检查原字段名是否正确，确保使用Keep Only Set Fields
- **问题**：计算错误
  - **解决**：检查数据类型，确保数值类型正确

### 练习3：数据合并项目

**任务目标**：从3个不同的API获取数据，使用Merge节点合并数据，处理数据冲突和缺失字段，输出统一的JSON格式

**前置条件**：
- 完成练习2
- 有3个可用的API（可以使用测试API）

**详细步骤**：

1. **获取多个数据源**
   - 添加Manual Trigger节点
   - 添加3个HTTP Request节点（并行）：
     - API 1：用户数据
     - API 2：订单数据
     - API 3：产品数据

2. **使用Merge节点合并数据**
   - 添加Merge节点
   - 连接3个HTTP Request节点
   - 选择合并模式：Merge By Key
   - 设置合并键：`userId`或`id`

3. **处理数据冲突**
   - 在Merge节点中配置冲突处理
   - 或使用Code节点处理：
   ```javascript
   const items = $input.all();
   return items.map(item => ({
     json: {
       ...item.json.source1,
       ...item.json.source2,
       ...item.json.source3,
       // 处理冲突：优先使用source1的数据
       name: item.json.source1?.name || item.json.source2?.name || item.json.source3?.name
     }
   }));
   ```

4. **处理缺失字段**
   - 使用Set节点添加默认值
   - 或使用Code节点：
   ```javascript
   const items = $input.all();
   return items.map(item => ({
     json: {
       id: item.json.id || 'unknown',
       name: item.json.name || 'N/A',
       status: item.json.status || 'pending',
       ...item.json
     }
   }));
   ```

5. **输出统一格式**
   - 使用Set节点标准化输出格式
   - 确保所有数据项有相同的字段结构

**预期结果**：
- 成功从3个API获取数据
- 数据成功合并
- 冲突和缺失字段正确处理
- 输出统一格式

**验证方法**：
- 检查合并后的数据是否完整
- 验证冲突处理是否正确
- 检查输出格式是否统一

**扩展挑战**：
- 处理更多数据源
- 实现智能冲突解决
- 添加数据质量检查

**故障排除**：
- **问题**：合并键不匹配
  - **解决**：检查数据源中的键值，确保有共同的键
- **问题**：数据丢失
  - **解决**：检查合并模式，确保使用正确的合并方式

### 练习4：数据过滤和条件处理

**任务目标**：创建处理100条数据记录的工作流，使用IF节点根据条件分流数据，统计每种情况的数量

**前置条件**：
- 完成前面的练习
- 理解条件判断

**详细步骤**：

1. **创建测试数据**
   - 添加Manual Trigger节点
   - 添加Code节点生成100条测试数据：
   ```javascript
   const items = [];
   for (let i = 1; i <= 100; i++) {
     items.push({
       json: {
         id: i,
         name: `User ${i}`,
         age: Math.floor(Math.random() * 50) + 18,
         status: Math.random() > 0.5 ? 'active' : 'inactive',
         amount: Math.floor(Math.random() * 1000)
       }
     });
   }
   return items;
   ```

2. **使用IF节点分流**
   - 添加IF节点
   - 配置条件：`{{ $json.status }}` equals `active`
   - 连接两个分支

3. **处理满足条件的数据**
   - 在True分支添加处理节点
   - 执行操作A（如发送通知）

4. **处理不满足条件的数据**
   - 在False分支添加处理节点
   - 执行操作B（如记录日志）

5. **统计数量**
   - 添加Code节点统计：
   ```javascript
   const items = $input.all();
   const activeCount = items.filter(i => i.json.status === 'active').length;
   const inactiveCount = items.length - activeCount;
   
   return [{
     json: {
       total: items.length,
       active: activeCount,
       inactive: inactiveCount,
       activePercentage: (activeCount / items.length * 100).toFixed(2) + '%'
     }
   }];
   ```

**预期结果**：
- 成功处理100条数据
- 数据正确分流
- 统计结果准确

**验证方法**：
- 检查分流是否正确
- 验证统计数量是否准确
- 确认操作A和B都执行

**扩展挑战**：
- 使用Switch节点实现多条件分流
- 添加更复杂的统计逻辑
- 实现数据分组统计

**故障排除**：
- **问题**：条件判断不准确
  - **解决**：检查数据类型，确保比较值类型一致
- **问题**：统计结果错误
  - **解决**：检查统计逻辑，确保计算正确

### 练习5：表达式语言深度练习

**任务目标**：完成20个表达式练习题，创建个人"表达式速查手册"，实现复杂的表达式

**前置条件**：
- 完成前面的练习
- 理解表达式语法

**详细步骤**：

1. **完成表达式练习题**
   - 创建20个不同的表达式练习
   - 包括：
     - 日期格式化（5题）
     - 字符串操作（5题）
     - 数学计算（5题）
     - 条件判断（5题）

2. **测试每个表达式**
   - 在工作流中测试每个表达式
   - 记录结果和说明

3. **创建表达式速查手册**
   - 整理所有表达式
   - 分类组织
   - 添加说明和示例

4. **实现复杂表达式**
   - 组合多个数据源
   - 进行条件判断和计算
   - 实现嵌套表达式

**预期结果**：
- 完成20个表达式练习
- 创建完整的表达式速查手册
- 实现复杂表达式

**验证方法**：
- 检查每个表达式是否正确
- 验证速查手册是否完整
- 测试复杂表达式是否工作

**表达式练习题示例**：

| 类别 | 题目 | 表达式 | 说明 |
|------|------|--------|------|
| 日期 | 格式化当前日期 | `{{ $now.format('YYYY-MM-DD') }}` | ISO日期格式 |
| 字符串 | 转换为大写 | `{{ $json.name.toUpperCase() }}` | 字符串转大写 |
| 数学 | 计算平均值 | `{{ ($json.total / $json.count).toFixed(2) }}` | 保留2位小数 |
| 条件 | 判断年龄组 | `{{ $json.age >= 18 ? 'adult' : 'minor' }}` | 三元运算符 |

**表达式速查手册结构**：

1. **基础访问**
   - 访问字段
   - 访问嵌套字段
   - 访问数组元素

2. **字符串操作**
   - 大小写转换
   - 字符串截取
   - 字符串替换
   - 字符串分割

3. **数字操作**
   - 基本运算
   - 数学函数
   - 格式化

4. **日期操作**
   - 当前时间
   - 日期格式化
   - 日期计算

5. **条件判断**
   - 三元运算符
   - 逻辑运算符
   - 比较运算符

**扩展挑战**：
- 研究更多表达式函数
- 创建自定义表达式函数
- 优化表达式性能

**故障排除**：
- **问题**：表达式语法错误
  - **解决**：检查语法，确保括号匹配
- **问题**：表达式返回错误结果
  - **解决**：检查数据类型，确保操作符正确

### 练习6：数组和批量处理

**任务目标**：理解Split In Batches节点的作用，创建处理大量数据的工作流，实现错误重试机制

**前置条件**：
- 完成前面的练习
- 理解数组处理

**详细步骤**：

1. **创建大量测试数据**
   - 添加Manual Trigger节点
   - 添加Code节点生成1000条数据

2. **使用Split In Batches节点**
   - 添加Split In Batches节点
   - 配置批次大小：50
   - 配置批次间隔：1000ms（1秒）

3. **处理每批数据**
   - 在Split In Batches后添加处理节点
   - 对每批数据执行操作

4. **实现错误重试**
   - 在处理节点中配置错误处理
   - 使用"Continue On Fail"选项
   - 添加重试逻辑

5. **合并结果**
   - 使用Item Lists节点合并结果
   - 或使用Code节点汇总

**预期结果**：
- 数据成功分批处理
- 错误重试机制工作
- 所有数据都处理完成

**验证方法**：
- 检查数据是否分批处理
- 验证错误重试是否生效
- 确认所有数据都处理

**扩展挑战**：
- 实现智能批次大小调整
- 添加处理进度跟踪
- 实现并行批次处理

**故障排除**：
- **问题**：批次处理超时
  - **解决**：增加批次间隔，减少批次大小
- **问题**：数据丢失
  - **解决**：检查合并逻辑，确保所有批次都处理

## 常见问题

**Q1：如何访问嵌套的JSON字段？**

A：使用点号（.）访问嵌套字段：
```javascript
{{ $json.user.profile.name }}
{{ $json.company.departments.Engineering.budget }}
```

**Q2：如何处理数组数据？**

A：有多种方式：
- 使用表达式访问：`{{ $json.items[0] }}`
- 使用Code节点处理：`items.map(item => ...)`
- 使用Item Lists节点拆分或合并

**Q3：表达式中的数据类型如何转换？**

A：
- 字符串转数字：`parseInt($json.price)` 或 `parseFloat($json.price)`
- 数字转字符串：`$json.id.toString()`
- 字符串转日期：`new Date($json.dateString)`

**Q4：如何判断字段是否存在？**

A：使用条件判断：
```javascript
{{ $json.field ? $json.field : 'default' }}
{{ $json.field || 'default' }}
```

**Q5：如何在表达式中使用多个条件？**

A：使用逻辑运算符：
```javascript
{{ $json.status === 'active' && $json.verified === true }}
{{ $json.role === 'admin' || $json.role === 'moderator' }}
```

**Q6：Code节点中的$input是什么？**

A：`$input`是Code节点中访问输入数据的对象：
- `$input.all()`：获取所有数据项
- `$input.item`：获取当前数据项
- `$input.first()`：获取第一个数据项

**Q7：如何格式化日期？**

A：使用表达式：
```javascript
{{ $now.format('YYYY-MM-DD') }}
{{ $json.date.format('YYYY-MM-DD HH:mm:ss') }}
```

**Q8：如何合并多个数据源？**

A：
- 使用Merge节点（推荐）
- 使用Code节点手动合并
- 使用Item Lists节点

**Q9：如何处理数据冲突？**

A：
- 在Merge节点中配置冲突处理规则
- 使用Code节点实现自定义冲突解决逻辑
- 设置优先级规则

**Q10：如何优化大数据处理性能？**

A：
- 使用Split In Batches分批处理
- 减少不必要的字段操作
- 使用Code节点批量处理
- 优化表达式复杂度

## 知识检查

### 选择题

1. **如何访问嵌套JSON字段？**
   - A. `{{ $json[user][name] }}`
   - B. `{{ $json.user.name }}`
   - C. `{{ $json->user->name }}`
   - D. `{{ json.user.name }}`
   - **答案**：B
   - **解释**：使用点号（.）访问嵌套字段。

2. **Code节点中如何获取所有输入数据？**
   - A. `$input.all()`
   - B. `$input.items`
   - C. `$input.data`
   - D. `$input.list()`
   - **答案**：A
   - **解释**：`$input.all()`返回所有输入数据项的数组。

3. **如何格式化数字保留2位小数？**
   - A. `{{ $json.price.round(2) }}`
   - B. `{{ $json.price.toFixed(2) }}`
   - C. `{{ $json.price.format(2) }}`
   - D. `{{ round($json.price, 2) }}`
   - **答案**：B
   - **解释**：使用`.toFixed(2)`方法格式化数字。

4. **Merge节点的合并模式有哪些？**
   - A. 只有Merge By Index
   - B. Merge By Index和Merge By Key
   - C. 只有Append
   - D. Merge By Index、Merge By Key和Append
   - **答案**：D
   - **解释**：Merge节点支持三种合并模式。

5. **如何判断字段是否存在？**
   - A. `{{ $json.field !== null }}`
   - B. `{{ $json.field ? $json.field : 'default' }}`
   - C. `{{ $json.field || 'default' }}`
   - D. 以上都可以
   - **答案**：D
   - **解释**：可以使用多种方式判断字段是否存在。

### 简答题

1. **请解释N8N中JSON数据的基本结构，并给出一个嵌套JSON的示例。**

   **答案示例**：
   N8N使用JSON格式传递数据，基本结构包含json、binary、error三个部分。嵌套JSON示例：
   ```json
   {
     "json": {
       "user": {
         "name": "John",
         "address": {
           "city": "Beijing"
         }
       }
     }
   }
   ```

2. **Set节点和Code节点有什么区别？各适用于什么场景？**

   **答案示例**：
   - **Set节点**：
     - 简单易用，可视化配置
     - 适合简单的字段操作（添加、修改、删除）
     - 适合标准化数据格式
   - **Code节点**：
     - 灵活强大，可以编写复杂逻辑
     - 适合复杂的数据处理
     - 适合需要循环、条件判断的场景

3. **请列出5个常用的表达式函数，并说明其用途。**

   **答案示例**：
   - `{{ $json.name.toUpperCase() }}`：字符串转大写
   - `{{ $json.price.toFixed(2) }}`：数字保留2位小数
   - `{{ $now.format('YYYY-MM-DD') }}`：格式化当前日期
   - `{{ $json.items.length }}`：获取数组长度
   - `{{ $json.age >= 18 ? 'adult' : 'minor' }}`：条件判断

4. **如何合并来自多个数据源的数据？请说明步骤。**

   **答案示例**：
   1. 获取多个数据源（使用多个HTTP Request节点）
   2. 添加Merge节点
   3. 连接所有数据源到Merge节点
   4. 选择合并模式（Merge By Key、Merge By Index或Append）
   5. 配置合并键（如果使用Merge By Key）
   6. 处理数据冲突和缺失字段

5. **如何处理大量数据以避免超时？**

   **答案示例**：
   1. 使用Split In Batches节点分批处理
   2. 设置合适的批次大小（如50或100）
   3. 设置批次间隔时间
   4. 使用Code节点批量处理
   5. 优化处理逻辑，减少不必要的操作

### 实践题

1. **创建数据转换工作流**
   - 从API获取数据
   - 使用Set节点重命名字段
   - 使用Code节点进行数据计算
   - 格式化输出数据

2. **实现数据合并和过滤**
   - 从多个数据源获取数据
   - 使用Merge节点合并
   - 使用IF节点过滤
   - 输出处理后的数据

3. **创建表达式速查手册**
   - 整理常用表达式
   - 分类组织
   - 添加示例和说明

## 延伸阅读

### 官方资源

1. **N8N表达式文档**
   - 网址：https://docs.n8n.io/code/expressions/
   - 内容：表达式语法和函数参考

2. **N8N节点文档**
   - 网址：https://docs.n8n.io/integrations/
   - 内容：所有节点的详细文档

3. **JSON规范**
   - 网址：https://www.json.org/
   - 内容：JSON格式的详细规范

### 学习资源

1. **JavaScript基础**
   - 学习JavaScript语法
   - 理解数组和对象操作
   - 掌握函数和条件语句

2. **JSON处理最佳实践**
   - 学习JSON数据结构
   - 理解数据验证
   - 掌握数据转换模式

3. **数据处理模式**
   - 学习ETL（提取、转换、加载）模式
   - 理解数据清洗技术
   - 掌握数据聚合方法

### 相关工具和概念

1. **数据转换工具**
   - 了解其他数据转换工具
   - 学习数据管道概念
   - 理解数据流处理

2. **表达式语言深入学习**
   - 研究JavaScript表达式
   - 学习函数式编程
   - 理解闭包和作用域

3. **性能优化**
   - 学习数据处理性能优化
   - 理解批量处理策略
   - 掌握内存管理

### 下一步学习

完成本章学习后，建议你：

1. **完成所有实践练习**
   - 确保你能够处理各种数据场景
   - 掌握表达式语言的使用
   - 理解数据转换和合并方法

2. **创建数据处理模板**
   - 整理常用的数据处理模式
   - 创建可重复使用的模板
   - 建立个人知识库

3. **优化现有工作流**
   - 改进数据处理逻辑
   - 优化表达式性能
   - 添加数据验证

4. **开始第六章学习**
   - 下一章将教你如何实现条件逻辑和循环控制
   - 学习IF、Switch、Loop等节点
   - 准备好创建更复杂的工作流

---

## 快速参考

### 常用表达式

| 功能 | 表达式 | 说明 |
|------|--------|------|
| 访问字段 | `{{ $json.name }}` | 访问简单字段 |
| 访问嵌套字段 | `{{ $json.user.name }}` | 访问嵌套字段 |
| 访问数组元素 | `{{ $json.items[0] }}` | 访问数组第一个元素 |
| 字符串转大写 | `{{ $json.name.toUpperCase() }}` | 字符串转大写 |
| 数字格式化 | `{{ $json.price.toFixed(2) }}` | 保留2位小数 |
| 日期格式化 | `{{ $now.format('YYYY-MM-DD') }}` | 格式化日期 |
| 条件判断 | `{{ $json.age >= 18 ? 'adult' : 'minor' }}` | 三元运算符 |
| 数组长度 | `{{ $json.items.length }}` | 获取数组长度 |

### 数据操作节点对比

| 节点 | 适用场景 | 复杂度 | 灵活性 |
|------|---------|--------|--------|
| Set | 简单字段操作 | ⭐ 简单 | ⭐⭐ 中等 |
| Code | 复杂数据处理 | ⭐⭐⭐ 复杂 | ⭐⭐⭐⭐⭐ 最高 |
| Function | 快速函数编写 | ⭐⭐ 中等 | ⭐⭐⭐ 中等 |
| Item Lists | 数组处理 | ⭐⭐ 中等 | ⭐⭐⭐ 中等 |
| Merge | 数据合并 | ⭐⭐ 中等 | ⭐⭐⭐ 中等 |

### 数据类型转换

| 转换类型 | 方法 | 示例 |
|---------|------|------|
| 字符串转数字 | `parseInt()` / `parseFloat()` | `parseInt($json.price)` |
| 数字转字符串 | `.toString()` | `$json.id.toString()` |
| 字符串转日期 | `new Date()` | `new Date($json.dateString)` |
| 日期转字符串 | `.format()` | `$json.date.format('YYYY-MM-DD')` |

---

**恭喜你完成第五章的学习！现在你已经能够处理和转换各种数据了。准备好学习如何实现条件逻辑和循环控制，创建更智能的工作流了吗？** 🚀

